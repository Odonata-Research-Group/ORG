// gif.worker.js â€” from gif.js 0.2.0 by Johan Nordberg (MIT license)
// Inlined to avoid CORS issues with GitHub Pages
var NeuQuant=function(pixels,netsize){var network,netindex,bias,freq,radpower;function init(){network=[];netindex=new Int32Array(256);bias=new Int32Array(netsize);freq=new Int32Array(netsize);radpower=new Int32Array(netsize>>3);var i,v;for(i=0;i<netsize;i++){v=(i<<(8+1))/netsize|0;network[i]=new Float64Array([v,v,v,0]);freq[i]=1<<(8- 4);bias[i]=0}}function unbiasnet(){for(var i=0;i<netsize;i++){network[i][0]>>=4;network[i][1]>>=4;network[i][2]>>=4;network[i][3]=i}}function altersingle(alpha,i,b,g,r){network[i][0]-=alpha*(network[i][0]-b)/1024;network[i][1]-=alpha*(network[i][1]-g)/1024;network[i][2]-=alpha*(network[i][2]-r)/1024}function alterneigh(radius,i,b,g,r){var lo=Math.abs(i-radius),hi=Math.min(i+radius,netsize);var j=i+1,k=i-1,m=1,p,a;while(j<hi||k>lo){a=radpower[m++];if(j<hi){p=network[j++];p[0]-=a*(p[0]-b)/1024;p[1]-=a*(p[1]-g)/1024;p[2]-=a*(p[2]-r)/1024}if(k>lo){p=network[k--];p[0]-=a*(p[0]-b)/1024;p[1]-=a*(p[1]-g)/1024;p[2]-=a*(p[2]-r)/1024}}}function contest(b,g,r){var bestd=~(1<<31),bestbiasd=bestd,bestpos=-1,bestbiaspos=bestpos,i,n,dist,biasdist,betafreq;for(i=0;i<netsize;i++){n=network[i];dist=Math.abs(n[0]-b)+Math.abs(n[1]-g)+Math.abs(n[2]-r);if(dist<bestd){bestd=dist;bestpos=i}biasdist=dist-(bias[i]>>(8- 4));if(biasdist<bestbiasd){bestbiasd=biasdist;bestbiaspos=i}betafreq=freq[i]>>3;freq[i]-=betafreq;bias[i]+=betafreq<<8}freq[bestpos]+=1<<(8- 4);bias[bestpos]-=1<<8;return bestbiaspos}function inxbuild(){var i,j,p,q,smallval,radius,s;var previouscol=0,startpos=0;for(i=0;i<netsize;i++){p=network[i];smallval=p[1];j=i;for(s=i+1;s<netsize;s++){q=network[s];if(q[1]<smallval){smallval=q[1];j=s}}q=network[j];if(i!=j){r=q[0];q[0]=p[0];p[0]=r;r=q[1];q[1]=p[1];p[1]=r;r=q[2];q[2]=p[2];p[2]=r;r=q[3];q[3]=p[3];p[3]=r}if(smallval!=previouscol){netindex[previouscol]=startpos+i>>1;for(j=previouscol+1;j<smallval;j++)netindex[j]=i;previouscol=smallval;startpos=i}}netindex[previouscol]=startpos+255>>1;for(j=previouscol+1;j<256;j++)netindex[j]=255}function lookup(b,g,r){var bestd=1e3,best=-1,i=netindex[g],j=i-1;while(i<netsize||j>=0){if(i<netsize){var p=network[i];var dist=p[1]-g;if(dist>=bestd)i=netsize;else{i++;dist=Math.abs(dist)+Math.abs(p[0]-b);if(dist<bestd){dist+=Math.abs(p[2]-r);if(dist<bestd){bestd=dist;best=p[3]}}}}if(j>=0){var p=network[j];var dist=g-p[1];if(dist>=bestd)j=-1;else{j--;dist=Math.abs(dist)+Math.abs(p[0]-b);if(dist<bestd){dist+=Math.abs(p[2]-r);if(dist<bestd){bestd=dist;best=p[3]}}}}}return best}function learn(){var i,j,b,g,r,radius,rad,alpha,step,delta,samplepixels;var pix=pixels;var alphadec=30+((netsize-1)/3|0);var lengthcount=pixels.length;var samplepixels=lengthcount/3|0;delta=samplepixels/100|0;alpha=1024;radius=netsize>>3;rad=radius>>3;if(rad<=1)rad=0;for(i=0;i<rad;i++)radpower[i]=alpha*((radius*radius-i*i)*110/(radius*radius));step=lengthcount%prime1!=0?3*prime1:lengthcount%prime2!=0?3*prime2:lengthcount%prime3!=0?3*prime3:3*prime4;for(i=0,j=0;i<samplepixels;){b=pix[j]&255;g=pix[j+1]&255;r=pix[j+2]&255;var n=contest(b,g,r);altersingle(alpha,n,b,g,r);if(rad!=0)alterneigh(rad,n,b,g,r);j+=step;if(j>=lengthcount)j-=lengthcount;i++;if(delta==0)delta=1;if(i%delta==0){alpha-=alpha/alphadec;radius-=radius/30;rad=radius>>3;if(rad<=1)rad=0;for(var k=0;k<rad;k++)radpower[k]=alpha*((radius*radius-k*k)*110/(radius*radius))}}}var prime1=499,prime2=491,prime3=487,prime4=503;init();learn();unbiasnet();inxbuild();return{map:lookup,colorMap:function(){var map=new Int32Array(netsize*3),i,j=0;for(i=0;i<netsize;i++){map[j++]=network[i][2]|0;map[j++]=network[i][1]|0;map[j++]=network[i][0]|0}return map}}};
var LZWEncoder=function(width,height,pixels,colorDepth){var initCodeSize=Math.max(2,colorDepth),accum=new Uint8Array(256),htab=new Int32Array(5003),codetab=new Int32Array(5003),EOF=-1,maxbits=12,maxmaxcode=1<<maxbits,BITS=initCodeSize+1,maxcode,free_ent,clear_flg=false,cur_accum=0,cur_bits=0,a_count=0,n_bits,g_init_bits,ClearCode,EOFCode,remaining,curPixel;function char_out(c,outs){accum[a_count++]=c;if(a_count>=254)flush_char(outs)}function flush_char(outs){if(a_count>0){outs.writeByte(a_count);outs.writeBytes(accum,0,a_count);a_count=0}}function getMaxCode(bits){return(1<<bits)-1}function output(code,outs){cur_accum&=masks[cur_bits];if(cur_bits>0)cur_accum|=code<<cur_bits;else cur_accum=code;cur_bits+=BITS;while(cur_bits>=8){char_out(cur_accum&255,outs);cur_accum>>=8;cur_bits-=8}if((free_ent>maxcode||clear_flg)&&code!=EOFCode){if(clear_flg){maxcode=getMaxCode(BITS=g_init_bits);clear_flg=false}else{++BITS;if(BITS==maxbits)maxcode=maxmaxcode;else maxcode=getMaxCode(BITS)}}if(code==EOFCode){while(cur_bits>0){char_out(cur_accum&255,outs);cur_accum>>=8;cur_bits-=8}flush_char(outs)}}var masks=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];function nextPixel(){if(remaining==0)return EOF;remaining--;return pixels[curPixel++]&255}function encode(outs){outs.writeByte(initCodeSize);remaining=width*height;curPixel=0;compress(initCodeSize+1,outs);outs.writeByte(0)}function compress(init_bits,outs){var fcode,c,i,ent,disp,hsize_reg,hshift;g_init_bits=init_bits;clear_flg=false;BITS=g_init_bits;maxcode=getMaxCode(BITS);ClearCode=1<<(init_bits-1);EOFCode=ClearCode+1;free_ent=ClearCode+2;a_count=0;ent=nextPixel();hshift=0;for(fcode=5003;fcode<65536;fcode*=2)++hshift;hshift=8-hshift;hsize_reg=5003;htab.fill(-1);output(ClearCode,outs);outer_loop:while((c=nextPixel())!=EOF){fcode=(c<<maxbits)+ent;i=c<<hshift^ent;if(htab[i]==fcode){ent=codetab[i];continue}else if(htab[i]>=0){disp=hsize_reg-i;if(i==0)disp=1;do{if((i-=disp)<0)i+=hsize_reg;if(htab[i]==fcode){ent=codetab[i];continue outer_loop}}while(htab[i]>=0)}output(ent,outs);ent=c;if(free_ent<maxmaxcode){codetab[i]=free_ent++;htab[i]=fcode}else{htab.fill(-1);output(ClearCode,outs);clear_flg=true;BITS=g_init_bits;maxcode=getMaxCode(BITS);free_ent=ClearCode+2}}output(ent,outs);output(EOFCode,outs)}return{encode:encode}};
self.onmessage=function(evt){var data=evt.data,frames=data.frames,options=data.options||{},paletteSize=options.paletteSize||256,delay=options.delay||10,dispose=options.dispose||-1,dither=options.dither||false,width=0,height=0,stream={data:[],writeByte:function(byte){this.data.push(byte)},writeBytes:function(bytes,start,count){for(var i=start;i<start+count;i++)this.data.push(bytes[i])},writeUTFBytes:function(str){for(var i=0;i<str.length;i++)this.data.push(str.charCodeAt(i))},writeUInt16:function(val){this.data.push(val&255,(val>>8)&255)}};if(!frames.length)return;width=frames[0].data.width;height=frames[0].data.height;var globalPalette=null,palettes=[];for(var f=0;f<frames.length;f++){var frame=frames[f],imageData=frame.data,pixels=new Uint8Array(imageData.width*imageData.height*3),data=imageData.data;for(var i=0,j=0;i<data.length;i+=4){pixels[j++]=data[i];pixels[j++]=data[i+1];pixels[j++]=data[i+2]}var nq=new NeuQuant(pixels,paletteSize);var palette=nq.colorMap();palettes.push({nq:nq,palette:palette,pixels:pixels})}stream.writeUTFBytes('GIF89a');stream.writeUInt16(width);stream.writeUInt16(height);var colorDepth=Math.ceil(Math.log(paletteSize)/Math.log(2)),firstPalette=palettes[0].palette;stream.writeByte(0xF0|(colorDepth-1));stream.writeByte(0);stream.writeByte(0);for(var i=0;i<firstPalette.length;i++)stream.writeByte(firstPalette[i]);if(frames.length>1){stream.writeByte(0x21);stream.writeByte(0xFF);stream.writeByte(11);stream.writeUTFBytes('NETSCAPE2.0');stream.writeByte(3);stream.writeByte(1);stream.writeUInt16(0);stream.writeByte(0)}for(var f=0;f<frames.length;f++){var p=palettes[f],frameDelay=frames[f].delay||delay,frameDispose=frames[f].dispose!=null?frames[f].dispose:dispose;self.postMessage({type:'progress',data:(f+1)/frames.length});stream.writeByte(0x21);stream.writeByte(0xF9);stream.writeByte(4);stream.writeByte(((frameDispose+1)<<3)|0);stream.writeUInt16(frameDelay/10|0);stream.writeByte(0);stream.writeByte(0);stream.writeByte(0x2C);stream.writeUInt16(0);stream.writeUInt16(0);stream.writeUInt16(width);stream.writeUInt16(height);stream.writeByte(0x80|(colorDepth-1));var localPalette=p.palette;for(var i=0;i<localPalette.length;i++)stream.writeByte(localPalette[i]);var indexedPixels=new Uint8Array(p.pixels.length/3);for(var i=0,j=0;i<p.pixels.length;i+=3,j++)indexedPixels[j]=p.nq.map(p.pixels[i],p.pixels[i+1],p.pixels[i+2]);var encoder=new LZWEncoder(width,height,indexedPixels,colorDepth);encoder.encode(stream);stream.writeByte(0)}stream.writeByte(0x3B);var blob=new Blob([new Uint8Array(stream.data)],{type:'image/gif'});self.postMessage({type:'finished',data:blob})};
