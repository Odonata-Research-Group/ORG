<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ORG — Low Poly Generator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400&display=swap');

  :root {
    --black: #080808;
    --white: #eeeae2;
    --dim: #1a1a1a;
    --mid: #333;
    --bright: #555;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--black);
    color: var(--white);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 32px 48px 24px;
    border-bottom: 1px solid var(--dim);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-shrink: 0;
  }

  .header-left { display: flex; flex-direction: column; gap: 12px; }
  .logo-img { width: auto; height: 52px; mix-blend-mode: screen; opacity: 0.92; }
  .page-label { font-size: 10px; letter-spacing: 0.25em; color: var(--white); text-transform: uppercase; }

  .header-right { text-align: right; font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase; line-height: 2.6; }
  .header-right a { color: var(--white); text-decoration: none; display: block; transition: opacity 0.2s; }
  .header-right a:hover { opacity: 0.4; }

  .app { display: grid; grid-template-columns: 1fr 300px; flex: 1; }

  .canvas-area {
    border-right: 1px solid var(--dim);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 48px;
  }

  .drop-zone {
    width: 100%;
    max-width: 640px;
    aspect-ratio: 1;
    border: 1px solid var(--mid);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    cursor: pointer;
    transition: border-color 0.15s;
    position: relative;
    overflow: hidden;
  }

  .drop-zone:hover { border-color: var(--bright); }
  .drop-zone.drag-over { border-color: var(--white); }
  .drop-icon { font-size: 28px; color: var(--mid); line-height: 1; }
  .drop-label { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--mid); text-align: center; line-height: 2; }
  .drop-sub { font-size: 9px; letter-spacing: 0.15em; color: #252525; text-transform: uppercase; }

  #preview-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; display: none; }
  #output-canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; display: none; }
  #file-input { display: none; }

  .controls { display: flex; flex-direction: column; padding: 36px 28px; }
  .controls-title { font-size: 9px; letter-spacing: 0.32em; text-transform: uppercase; color: var(--bright); margin-bottom: 28px; }
  .control-group { padding: 18px 0; border-bottom: 1px solid var(--dim); }
  .control-label { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .control-name { font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--white); }
  .control-value { font-size: 9px; color: var(--bright); }

  input[type="range"] { -webkit-appearance: none; width: 100%; height: 1px; background: var(--mid); outline: none; cursor: pointer; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 9px; height: 9px; background: var(--white); border-radius: 50%; cursor: pointer; transition: transform 0.1s; }
  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.5); }

  .toggle-group { display: flex; gap: 4px; }
  .toggle-btn { flex: 1; background: none; border: 1px solid var(--mid); color: var(--bright); font-family: 'IBM Plex Mono', monospace; font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; padding: 6px 4px; cursor: pointer; transition: all 0.1s; }
  .toggle-btn:hover { border-color: var(--bright); color: var(--white); }
  .toggle-btn.active { background: var(--white); color: var(--black); border-color: var(--white); }

  .actions { margin-top: auto; padding-top: 28px; display: flex; flex-direction: column; gap: 6px; }
  .status { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--bright); text-align: center; padding: 8px 0; min-height: 26px; }
  .progress-wrap { height: 1px; background: var(--dim); margin: 2px 0 8px; overflow: hidden; opacity: 0; transition: opacity 0.2s; }
  .progress-wrap.visible { opacity: 1; }
  .progress-fill { height: 100%; background: var(--white); width: 0%; transition: width 0.15s; }

  .btn-generate { width: 100%; background: var(--white); color: var(--black); border: none; font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase; padding: 13px; cursor: pointer; transition: opacity 0.15s; }
  .btn-generate:hover { opacity: 0.82; }
  .btn-generate:disabled { opacity: 0.18; cursor: not-allowed; }

  .btn-download { width: 100%; background: none; color: var(--white); border: 1px solid var(--mid); font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase; padding: 13px; cursor: pointer; transition: border-color 0.15s; display: none; }
  .btn-download:hover { border-color: var(--white); }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <a href="index.html"><img class="logo-img" src="ORG.png" alt="ORG"></a>
    <span class="page-label">002 — Low Poly Generator</span>
  </div>
  <div class="header-right">
    <a href="index.html">Index</a>
    <a href="https://instagram.com/odonataresearchgroup" target="_blank">Instagram</a>
    <a href="https://github.com/odonata-research-group/ORG" target="_blank">GitHub</a>
  </div>
</header>

<div class="app">
  <div class="canvas-area">
    <div class="drop-zone" id="drop-zone">
      <div class="drop-icon">+</div>
      <div class="drop-label">Drop image here<br>or click to upload</div>
      <div class="drop-sub">JPG · PNG · WEBP</div>
      <img id="preview-img" alt="">
      <canvas id="output-canvas"></canvas>
    </div>
    <input type="file" id="file-input" accept="image/*">
  </div>

  <div class="controls">
    <div class="controls-title">Parameters</div>

    <div class="control-group">
      <div class="control-label">
        <span class="control-name">Triangles</span>
        <span class="control-value" id="val-points">600</span>
      </div>
      <input type="range" id="sl-points" min="100" max="2500" value="600" step="50">
    </div>

    <div class="control-group">
      <div class="control-label">
        <span class="control-name">Edge Bias</span>
        <span class="control-value" id="val-edge">60</span>
      </div>
      <input type="range" id="sl-edge" min="0" max="100" value="60">
    </div>

    <div class="control-group">
      <div class="control-label"><span class="control-name">Colour</span></div>
      <div class="toggle-group">
        <button class="toggle-btn" data-mode="color">Full</button>
        <button class="toggle-btn active" data-mode="mono">Mono</button>
        <button class="toggle-btn" data-mode="invert">Invert</button>
      </div>
    </div>

    <div class="control-group">
      <div class="control-label"><span class="control-name">Edges</span></div>
      <div class="toggle-group">
        <button class="toggle-btn active" data-stroke="none">None</button>
        <button class="toggle-btn" data-stroke="soft">Soft</button>
        <button class="toggle-btn" data-stroke="hard">Hard</button>
      </div>
    </div>

    <div class="actions">
      <div class="status" id="status">Upload an image to begin</div>
      <div class="progress-wrap" id="progress-wrap">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <button class="btn-generate" id="btn-generate" disabled>Generate</button>
      <button class="btn-download" id="btn-download">Download PNG</button>
    </div>
  </div>
</div>

<!-- Delaunator — battle-tested Delaunay triangulation -->
<script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>

<script>
let srcImage = null;
let colorMode = 'mono';
let strokeMode = 'none';

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const preview   = document.getElementById('preview-img');
const canvas    = document.getElementById('output-canvas');
const btnGen    = document.getElementById('btn-generate');
const btnDL     = document.getElementById('btn-download');
const statusEl  = document.getElementById('status');

// ── Upload ────────────────────────────────────────────────────────────────────
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) loadFile(f);
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) loadFile(e.target.files[0]); });

function loadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      srcImage = img;
      preview.src = e.target.result;
      preview.style.display = 'block';
      canvas.style.display = 'none';
      dropZone.querySelector('.drop-icon').style.display = 'none';
      dropZone.querySelector('.drop-label').style.display = 'none';
      dropZone.querySelector('.drop-sub').style.display = 'none';
      btnGen.disabled = false;
      btnDL.style.display = 'none';
      setStatus('Ready — hit Generate');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ── Sliders ───────────────────────────────────────────────────────────────────
['points','edge'].forEach(id => {
  const sl = document.getElementById('sl-' + id);
  const vl = document.getElementById('val-' + id);
  sl.addEventListener('input', () => { vl.textContent = sl.value; });
});

// ── Toggles ───────────────────────────────────────────────────────────────────
document.querySelectorAll('[data-mode]').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('[data-mode]').forEach(x => x.classList.remove('active'));
    b.classList.add('active'); colorMode = b.dataset.mode;
  });
});
document.querySelectorAll('[data-stroke]').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('[data-stroke]').forEach(x => x.classList.remove('active'));
    b.classList.add('active'); strokeMode = b.dataset.stroke;
  });
});

// ── Generate ──────────────────────────────────────────────────────────────────
btnGen.addEventListener('click', generate);

async function generate() {
  if (!srcImage) return;
  btnGen.disabled = true;
  btnDL.style.display = 'none';
  setProgress(0, true);
  setStatus('Sampling image...');
  await tick();

  const nPts     = parseInt(document.getElementById('sl-points').value);
  const edgeBias = parseInt(document.getElementById('sl-edge').value) / 100;

  // Offscreen canvas
  const W = Math.min(srcImage.width, 800);
  const H = Math.round(srcImage.height * (W / srcImage.width));
  const off = document.createElement('canvas');
  off.width = W; off.height = H;
  const octx = off.getContext('2d');
  octx.drawImage(srcImage, 0, 0, W, H);
  const imgData = octx.getImageData(0, 0, W, H);

  setProgress(20); setStatus('Detecting edges...'); await tick();
  const edges = sobelEdges(imgData);

  setProgress(35); setStatus('Placing points...'); await tick();

  // Build points as array-of-arrays with jitter to avoid collinear issues
  const jitter = () => (Math.random() - 0.5) * 0.5;
  const pts = [
    [1 + jitter(),     1 + jitter()],
    [W-2 + jitter(),   1 + jitter()],
    [1 + jitter(),     H-2 + jitter()],
    [W-2 + jitter(),   H-2 + jitter()],
    [W/2 + jitter(),   1 + jitter()],
    [1 + jitter(),     H/2 + jitter()],
    [W-2 + jitter(),   H/2 + jitter()],
    [W/2 + jitter(),   H-2 + jitter()]
  ];

  let tries = 0;
  while (pts.length < nPts + 8 && tries < nPts * 40) {
    tries++;
    const x = 2 + Math.random() * (W - 4);
    const y = 2 + Math.random() * (H - 4);
    const e = edges[Math.floor(y) * W + Math.floor(x)] || 0;
    if (Math.random() < (0.1 + edgeBias * e * 3.0)) {
      pts.push([x + jitter(), y + jitter()]);
    }
  }

  setProgress(50); setStatus('Triangulating ' + pts.length + ' points...'); await tick();

  const d = Delaunator.from(pts);
  const triCount = d.triangles.length / 3;

  setProgress(75); setStatus('Rendering ' + triCount + ' triangles...'); await tick();

  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#080808';
  ctx.fillRect(0, 0, W, H);

  for (let i = 0; i < d.triangles.length; i += 3) {
    const ai = d.triangles[i], bi = d.triangles[i+1], ci = d.triangles[i+2];
    const ax = pts[ai][0], ay = pts[ai][1];
    const bx = pts[bi][0], by = pts[bi][1];
    const cx = pts[ci][0], cy = pts[ci][1];
    const mx = (ax+bx+cx)/3, my = (ay+by+cy)/3;

    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(bx, by);
    ctx.lineTo(cx, cy);
    ctx.closePath();
    ctx.fillStyle = getColor(imgData, W, mx, my, colorMode);
    ctx.fill();

    if (strokeMode !== 'none') {
      ctx.strokeStyle = strokeMode === 'soft' ? 'rgba(8,8,8,0.25)' : 'rgba(8,8,8,0.8)';
      ctx.lineWidth   = strokeMode === 'soft' ? 0.4 : 0.9;
      ctx.stroke();
    }
  }

  setProgress(100);
  preview.style.display = 'none';
  canvas.style.display = 'block';
  btnGen.disabled = false;
  btnDL.style.display = 'block';
  setStatus(triCount + ' triangles generated');
  setTimeout(() => setProgress(0, false), 600);
}

btnDL.addEventListener('click', () => {
  const a = document.createElement('a');
  a.download = 'ORG-lowpoly.png';
  a.href = canvas.toDataURL();
  a.click();
});

// ── Edge Detection (Sobel) ────────────────────────────────────────────────────
function sobelEdges(imgData) {
  const {width: W, height: H, data: d} = imgData;
  const out = new Float32Array(W * H);
  const lum = (x, y) => {
    const i = (y*W+x)*4;
    return (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114) / 255;
  };
  for (let y = 1; y < H-1; y++) {
    for (let x = 1; x < W-1; x++) {
      const gx = -lum(x-1,y-1) + lum(x+1,y-1) - 2*lum(x-1,y) + 2*lum(x+1,y) - lum(x-1,y+1) + lum(x+1,y+1);
      const gy = -lum(x-1,y-1) - 2*lum(x,y-1) - lum(x+1,y-1) + lum(x-1,y+1) + 2*lum(x,y+1) + lum(x+1,y+1);
      out[y*W+x] = Math.sqrt(gx*gx + gy*gy);
    }
  }
  let max = 0;
  for (let i = 0; i < out.length; i++) if (out[i] > max) max = out[i];
  if (max > 0) for (let i = 0; i < out.length; i++) out[i] /= max;
  return out;
}

// ── Point Placement ───────────────────────────────────────────────────────────
function placePoints(edges, W, H, n, bias) {
  // Always include corners and edge midpoints
  const pts = [[0,0],[W-1,0],[0,H-1],[W-1,H-1],[W/2,0],[0,H/2],[W-1,H/2],[W/2,H-1]];
  let tries = 0;
  while (pts.length < n + 8 && tries < n * 40) {
    tries++;
    const x = Math.random() * W;
    const y = Math.random() * H;
    const e = edges[Math.floor(y)*W + Math.floor(x)] || 0;
    // Higher edge bias = more points near edges
    const threshold = 0.1 + bias * e * 3.0;
    if (Math.random() < threshold) {
      pts.push([
        Math.max(0, Math.min(W-1, x + (Math.random()-0.5)*3)),
        Math.max(0, Math.min(H-1, y + (Math.random()-0.5)*3))
      ]);
    }
  }
  return pts;
}

// ── Color Sampling ────────────────────────────────────────────────────────────
function getColor(imgData, W, x, y, mode) {
  const px = Math.max(0, Math.min(imgData.width-1,  Math.round(x)));
  const py = Math.max(0, Math.min(imgData.height-1, Math.round(y)));
  const i  = (py*W+px)*4;
  let r = imgData.data[i], g = imgData.data[i+1], b = imgData.data[i+2];
  if (mode === 'mono' || mode === 'invert') {
    let v = Math.round(r*0.299 + g*0.587 + b*0.114);
    if (mode === 'invert') v = 255 - v;
    r = g = b = v;
  }
  return `rgb(${r},${g},${b})`;
}

// ── Utils ─────────────────────────────────────────────────────────────────────
function setStatus(msg) { statusEl.textContent = msg; }
function tick() { return new Promise(r => setTimeout(r, 16)); }
function setProgress(pct, show) {
  document.getElementById('progress-fill').style.width = pct + '%';
  if (show !== undefined) document.getElementById('progress-wrap').classList.toggle('visible', show);
}
</script>
</body>
</html>
